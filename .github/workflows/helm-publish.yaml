name: Publish Helm Chart

on:
  release:
    types:
      - published
  push:
    branches:
    - main
    tags:
    - v*
    paths-ignore:
    - 'docs/**'
    - '**/*.md'
  pull_request:
    paths-ignore:
    - 'docs/**'
    - '**/*.md'
    types: [labeled, unlabeled, opened, synchronize, reopened]

jobs:
  publish:
    runs-on: arc-scale-set
    permissions:
      contents: read
      packages: write
    # Condition: Run on tag push, published release, OR PR with 'ok-to-helm' label
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'ok-to-helm')) ||
      (github.event_name == 'release' && github.event.action == 'published')

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v4.0.1'

      - name: Login to GitHub Container Registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Remove 'v' prefix from tag if present (e.g., v0.1.0 -> 0.1.0)
            VERSION=${GITHUB_REF_NAME#v}
            echo "source=tag" >> $GITHUB_OUTPUT
          else
            # For pull requests and other refs, compute a semver version
            # Format: 0.0.0-pr.<pr_number>.<short_sha>
            PR_NUMBER=${{ github.event.pull_request.number }}
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            VERSION="0.0.0-pr.${PR_NUMBER}.${SHORT_SHA}"
            echo "source=computed" >> $GITHUB_OUTPUT
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Chart version: ${VERSION}"

      - name: Update chart version and appVersion
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for chart in charts/*/; do
            if [ -f "${chart}Chart.yaml" ]; then
              CHART_NAME=$(basename "${chart}")
              echo "Updating ${CHART_NAME} to version ${VERSION}"

              # Update version and appVersion in Chart.yaml
              # Use | as delimiter to avoid issues with / in version strings
              sed -i "s|^version:.*|version: ${VERSION}|" "${chart}Chart.yaml"
              sed -i "s|^appVersion:.*|appVersion: \"${VERSION}\"|" "${chart}Chart.yaml"

              echo "Updated Chart.yaml:"
              grep -E '^(version|appVersion):' "${chart}Chart.yaml"
            fi
          done

      - name: Package and publish Helm charts
        run: |
          for chart in charts/*/; do
            if [ -f "${chart}Chart.yaml" ]; then
              CHART_NAME=$(basename "${chart}")
              echo "Packaging and publishing chart: ${CHART_NAME}"

              # Package the chart
              helm package "${chart}"

              # Push to OCI registry
              PACKAGE=$(ls ${CHART_NAME}-*.tgz)
              helm push "${PACKAGE}" oci://ghcr.io/${{ github.repository_owner }}/charts

              echo "âœ“ Published ${PACKAGE} to ghcr.io/${{ github.repository_owner }}/charts"
            fi
          done
